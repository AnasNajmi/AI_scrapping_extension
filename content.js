console.log("Content script loaded");function g(e){return e.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g)||[]}function d(){return Array.from(document.images).map(e=>e.src)}function h(){const e=window.location.href,t=document.title,r=window.location.hostname;return{url:e,title:t,domain:r}}function w(e){const t=[],r=window.location.href;try{const o=["[data-item]",".item",".card",".product",".listing","article","tr",".row",".result",'[class*="item"]'];let n=null;for(const l of o){const a=document.querySelectorAll(l);if(a.length>1){n=a;break}}return(!n||n.length===0)&&(n=document.querySelectorAll("body")),n.forEach((l,a)=>{if(e.maxRows&&t.length>=e.maxRows)return;const u={};let f=!1;if(e.fields.forEach(s=>{try{const m=l.querySelectorAll(s.selector);let i="";m.length>0&&(s.type==="url"||s.type==="image"?i=Array.from(m).map(c=>c instanceof HTMLAnchorElement?c.href:c instanceof HTMLImageElement?c.src:c.getAttribute("href")||c.getAttribute("src")||"").filter(c=>c):i=Array.from(m).map(c=>c.textContent?.trim()||"").filter(c=>c).join(" | "),i&&i.length>0&&(f=!0)),u[s.name]=i}catch(m){console.error(`Error extracting field ${s.name}:`,m),u[s.name]=""}}),f){const s={...u,_meta:{pageIndex:0,rowIndex:a,extractedAt:new Date().toISOString(),source:r}};t.push(s)}}),t}catch(o){return console.error("Error extracting data:",o),[]}}async function y(e){return new Promise(t=>{let r=0,o=document.body.scrollHeight,n;const l=()=>{const a=document.body.scrollHeight;a>o&&(o=a,clearTimeout(n),r<e.maxScrolls?(r++,window.scrollTo(0,document.body.scrollHeight),n=setTimeout(t,e.idleTimeout)):t())};window.scrollTo(0,document.body.scrollHeight),r++,window.addEventListener("scroll",l),n=setTimeout(()=>{window.removeEventListener("scroll",l),t()},e.idleTimeout)})}function x(e){try{const t=document.querySelector(e);return t&&t.offsetParent!==null?(t.click(),!0):!1}catch(t){return console.error("Error clicking next page:",t),!1}}chrome.runtime.onMessage.addListener((e,t,r)=>{console.log("Content script received message:",e);try{switch(e.action){case"getPageInfo":const o=h();r({success:!0,pageInfo:o});break;case"extractCurrentPage":const n=w(e.config);r({success:!0,data:n});break;case"scrollPage":return y(e.scrollConfig).then(()=>{r({success:!0})}).catch(f=>{r({success:!1,error:f.message})}),!0;case"clickNextPage":const l=x(e.nextSelector);r({success:l});break;case"SCRAPE_PAGE":const a=g(document.body.innerText),u=d();r({emails:a,images:u});break;default:r({success:!1,error:"Unknown action"})}}catch(o){console.error("Content script error:",o),r({success:!1,error:o instanceof Error?o.message:"Unknown error"})}return!0});
